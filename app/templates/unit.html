{% extends "base.html" %}
{% block content %}
    <div class="unit-header">
        <h1>{{ unit.code }} - {{ unit.name }}</h1>
        <p>{{ unit.description }}</p>
        <p>Faculty: {{ unit.faculty }}</p>

        <!-- Poll UI -->
        <div class="poll-container">
            <div class="poll-bar-container">
                <button
                    id="goodButton"
                    onclick="voteUnit('good')"
                    class="poll-button good-button"
                >
                    Good
                </button>
                <div class="bar-wrapper">
                    <div id="goodBar" class="bar-left"></div>
                    <div id="badBar" class="bar-right"></div>
                </div>
                <button
                    id="badButton"
                    onclick="voteUnit('bad')"
                    class="poll-button bad-button"
                >
                    Bad
                </button>
            </div>

            <div class="vote-count">
                <p>Good Votes: <span id="goodVotes">{{ unit.good_votes }}</span></p>
                <p>Bad Votes: <span id="badVotes">{{ unit.bad_votes }}</span></p>
                <p>Total Votes: <span id="totalVotes">{{ unit.total_votes }}</span></p>
            </div>
        </div>

        <!-- accordion drop down-->
         <!-- extra  information we are adding, credit points, assessment summary, handbook link  -->
        <!-- Collapsible Extra Information -->
        <div class="collapsible-section">
          <button class="collapsible-header" onclick="toggleCollapse(this)">
            Extra Information →
          </button>
          <div class="collapsible-content">
            <p><strong>Credit Points:</strong> {{ unit.credit_points }}</p>
            <p><strong>Assessment Summary:</strong> {{ unit.assessment_summary }}</p>
            <p><strong>Handbook Link:</strong> <a href="{{ unit.handbook_link }}" target="_blank">View Handbook</a></p>
          </div>
        </div>
        <script>
            // Toggle collapsible functionality
            function toggleCollapse(button) {
            const content = button.nextElementSibling; // Get the collapsible content
            const isCollapsed = content.style.maxHeight === '' || content.style.maxHeight === '0px';

            // Toggle the arrow direction
            button.textContent = isCollapsed
                ? button.textContent.replace('→', '↓')
                : button.textContent.replace('↓', '→');

            // Expand or collapse the content
            if (isCollapsed) {
                content.style.maxHeight = content.scrollHeight + 'px'; // Expand
            } else {
                content.style.maxHeight = '0px'; // Collapse
            }
            }
        </script>
                <!-- Sort Options -->
        <div class="sort-container">
            <label for="sortDropdown">Sort by:</label>
            <select id="sortDropdown" class="sort-dropdown">
            <option value="{{ url_for('main.unit', code=unit.code, sort='newest') }}"
                    {% if sort == 'newest' %}selected{% endif %}>Newest</option>
            <option value="{{ url_for('main.unit', code=unit.code, sort='highest_rated') }}"
                    {% if sort == 'highest_rated' %}selected{% endif %}>Highest Rated</option>
            <option value="{{ url_for('main.unit', code=unit.code, sort='most_voted') }}"
                    {% if sort == 'most_voted' %}selected{% endif %}>Most Voted</option>
            </select>
        </div>

        
    </div>


    <script>
        // Add an event listener to the dropdown
        document.getElementById('sortDropdown').addEventListener('change', function () {
          const selectedUrl = this.value; // Get the selected URL
          window.location.href = selectedUrl; // Redirect to the selected URL
        });
    </script>

    <!-- Reviews Section -->
    <div class="reviews-section">
        {% for review in reviews.items %}
            <div class="review-card">
                <div class="review-header">
                    <span class="review-author">
                        {% if review.author %}
                            {{ review.author.username }}
                        {% else %}
                            Anonymous
                        {% endif %}
                    </span>
                    <span class="review-date">{{ review.timestamp.strftime('%Y-%m-%d') }}</span>
                </div>
                <div class="review-rating">
                    {% for _ in range(review.rating) %}⭐{% endfor %}
                </div>
                <div class="review-content">
                    {{ review.content }}
                </div>
                {% if current_user.is_authenticated %}
                    <div class="review-votes">
                        <button onclick="voteReview('{{ review.id }}', 'up')"
                                class="vote-btn upvote {% if review.has_voted(current_user, 'up') %}active{% endif %}">
                            ▲ <span class="vote-count">{{ review.upvotes }}</span>
                        </button>
                        <button onclick="voteReview('{{ review.id }}', 'down')"
                                class="vote-btn downvote {% if review.has_voted(current_user, 'down') %}active{% endif %}">
                            ▼ <span class="vote-count">{{ review.downvotes }}</span>
                        </button>
                    </div>
                {% endif %}
            </div>
        {% endfor %}

        <!-- Pagination -->
        {% if reviews.pages > 1 %}
            <div class="pagination">
                {% for page in reviews.iter_pages() %}
                    {% if page %}
                        <a href="{{ url_for('main.unit', code=unit.code, page=page, sort=sort) }}"
                           class="{% if page == reviews.page %}active{% endif %}">
                            {{ page }}
                        </a>
                    {% else %}
                        <span class="ellipsis">...</span>
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
    </div>

{% endblock %}